name: Release Homebrew

on:
  repository_dispatch:
    types: [homebrew-release]

env:
  CARGO_TERM_COLOR: always

jobs:
  generate-formula:
    name: Generate Homebrew Formula
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.client_payload.repo }}

    - name: Get version from dispatch
      id: get_version
      run: |
        TAG="${{ github.event.client_payload.version }}"
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Generate Homebrew formula
      run: |
        REPO_NAME="${{ github.event.client_payload.repo }}"
        TAG="${{ steps.get_version.outputs.tag }}"

        # Calculate SHA256 for macOS x86_64 binary
        MACOS_X86_SHA=$(curl -sL "https://github.com/${REPO_NAME}/releases/download/${TAG}/soundcheck-x86_64-apple-darwin.tar.gz" | sha256sum | cut -d' ' -f1)
        MACOS_ARM_SHA=$(curl -sL "https://github.com/${REPO_NAME}/releases/download/${TAG}/soundcheck-aarch64-apple-darwin.tar.gz" | sha256sum | cut -d' ' -f1)

        FORMULA=$(cat << EOF
        class Soundcheck < Formula
          desc "Terminal-based audio monitoring application"
          homepage "https://github.com/${REPO_NAME}"
          url "https://github.com/${REPO_NAME}/releases/download/${TAG}/soundcheck-x86_64-apple-darwin.tar.gz"
          sha256 "${MACOS_X86_SHA}"
          version "${TAG#v}"

          on_macos do
            if Hardware::CPU.arm?
              url "https://github.com/${REPO_NAME}/releases/download/${TAG}/soundcheck-aarch64-apple-darwin.tar.gz"
              sha256 "${MACOS_ARM_SHA}"
            end
          end

          def install
            bin.install "soundcheck"
          end

          test do
            system "#{bin}/soundcheck", "--help"
          end
        end
        EOF
        )

        echo "$FORMULA" > soundcheck.rb

    - name: Upload formula artifact
      uses: actions/upload-artifact@v4
      with:
        name: homebrew-formula
        path: soundcheck.rb

  update-tap:
    name: Update Homebrew Tap
    needs: generate-formula
    runs-on: ubuntu-latest

    steps:
    - name: Checkout tap repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}
        path: tap-repo
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download formula
      uses: actions/download-artifact@v4
      with:
        name: homebrew-formula
        path: .

    - name: Get version
      id: get_version
      run: |
        VERSION=$(cat soundcheck.rb | grep "version" | head -1 | sed 's/.*version "\([^"]*\)".*/\1/')
        echo "version=v$VERSION" >> $GITHUB_OUTPUT

    - name: Commit and push formula
      run: |
        cd tap-repo
        cp ../soundcheck.rb Formula/soundcheck.rb

        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add Formula/soundcheck.rb

        if git diff --staged --quiet; then
          echo "No changes to formula"
        else
          git commit -m "Update soundcheck to ${{ steps.get_version.outputs.version }}"
          git push
        fi